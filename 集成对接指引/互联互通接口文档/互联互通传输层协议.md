# 隐私计算传输协议 -- PTP/1.0

查看英文版 [PTP/1.0](Specifications.md)

## 说明

本文档为隐私计算传输规范，目前主要面向金融行业，并随时针对各行业针对互联互通提出的讨论和建议做优化。

## 版权

本标准由北京金融科技产业联盟（Beijing FinTech Industry Alliance）牵头起草，各个隐私计算技术服务商各自实现该标准，版权由北京金融科技产业联盟所有。

**开源协议**

| 协议名     | 地址                                              |
| ---------- | ------------------------------------------------- |
| Apache 2.0 | <http://www.apache.org/licenses/LICENSE-2.0.html> |

## 联系人信息

关于文件内容如有问题可以联系XXX（联系人信息）

## 内容目录

- 1 节点间通信接口

  - 1.1 报文定义

  - 1.2 接口定义

- 2 容器调用通信模块接口

  - 2.1 报文定义

  - 2.2 接口定义

  - 2.3 运行模式

- 3 传输编程接口

  - 3.1 传输编程接口定义

- 4 标准实现库

  - 4.1 通信模块

  - 4.1 Go SDK

  - 4.2 Java SDK

  - 4.3 Python SDK

  - 4.4 Rust SDK

  - 4.5 Typescript SDK

- 5 附录

  - 5.1 错误码表

  - 5.2 Protobuf 格式声明

  - 5.3 Swagger 格式声明

  - 5.4 示例程序

  - 5.5 高级特性

### 1 节点间通信接口

节点间通信接口是指两个通信模块间进行跨域数据传输的接口。定义了流式和非流式的传输接口以及基于 HTTP 协议的报文头。

#### 1.1 报文定义

节点间通信报文含报头和报文两部分，报头携带通信元数据，报文透传二进制传输内容。

互联互通使用 HTTP（HTTP/0.9 HTTP/1.0 HTTP/1.1 HTTP/2）作为底层通信协议，复用 HTTP 报头传输互联互通报头。

- 报头

```shell
x-ptp-version:               required 协议版本
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-uri                    required 互联互通资源定位符，为跨节点实际请求的资源路径，用于兼容多协议
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-source-node-id         required 发送端节点编号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-source-inst-id         optional 发送端机构编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

- 报文

```shell
互联互通下节点间通信报文透传二进制报文，复用HTTP协议Body传输。
```

#### 1.2 接口定义

节点间通信提供两个传输接口，非流式调用，针对单次调用场景；流式接口，针对大数据/小报文连续传输场景。

##### 1.2.1 非流式接口定义

针对单次调用场景

```shell
HTTP POST /v1/interconn/chan/invoke
请求头:
x-ptp-version:               required 协议版本
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-uri                    required 互联互通资源定位符，为跨节点实际请求的资源路径，用于兼容多协议
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-source-node-id         required 发送端节点编号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-source-inst-id         optional 发送端机构编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
请求体:
透传二进制报文，不做特殊处理

响应体:
透传二进制报文，不做特殊处理
```

##### 1.2.2 流式接口定义

针对大数据/小报文连续传输场景

```shell
HTTP POST /v1/interconn/chan/transport
请求头:
x-ptp-version:               required 协议版本
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-uri                    required 互联互通资源定位符，为跨节点实际请求的资源路径，用于兼容多协议
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-source-node-id         required 发送端节点编号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-source-inst-id         optional 发送端机构编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
请求体:
透传二进制报文，不做特殊处理

响应体:
透传二进制报文，不做特殊处理
```

### 2 容器调用通信模块接口

容器调用通信模块接口，采用 HTTP 协议为基础，所以该文档中定义了基于 HTTP 协议的报文和接口。

### 2.1 报文定义

- 报头

```shell
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

- 报文

```shell
互联互通下节点间通信报文透传二进制报文，复用HTTP协议Body传输。
```

### 2.2 接口定义

内部通信协议接口定义包含，**数据发送、接收数据、快速获取数据、会话释放** 四个接口。资源释放为可选。

#### 2.2.1 数据发送接口

容器调用通信模块发送数据。

```shell
HTTP POST /v1/interconn/chan/push
请求头:
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

**请求体**

| 参数名称 | 数据类型 | 默认值 | 是否必填 | 描述                                                 |
| -------- | -------- | ------ | -------- | ---------------------------------------------------- |
| payload  | byte\[]  | 空     | true     | 消息序列化后的字节数组                               |
| topic    | string   | 空     | false    | 会话主题，相同信道具有唯一性，用于同一信道的传输隔离 |
| metadata | object   | 空     | false    | 保留参数，用于扩展性                                 |

**响应体**

| 参数名称 | 类型   | 默认值      | 是否必填 | 描述                                       |
| -------- | ------ | ----------- | -------- | ------------------------------------------ |
| code     | string | E0000000000 | true     | 状态码，E0000000000 表示成功，其余均为失败 |
| message  | string | 成功        | true     | 状态说明                                   |

#### 2.2.2 接收数据接口

容器调用通信模块接口获取数据，该接口会从通信信道中阻塞读取一次数据，如信道中无数据，会一直阻塞等待触发超时返回空。

```shell
HTTP POST /v1/interconn/chan/pop
请求头:
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

**请求体**

| 参数名称 | 数据类型 | 默认值 | 是否必填 | 描述                                                 |
| -------- | -------- | ------ | -------- | ---------------------------------------------------- |
| timeout  | byte\[]  | 空     | false    | 阻塞超时时间，默认 120s                              |
| topic    | string   | 空     | false    | 会话主题，相同信道具有唯一性，用于同一信道的传输隔离 |

**响应体**

| 参数名称 | 类型    | 默认值      | 是否必填 | 描述                                       |
| -------- | ------- | ----------- | -------- | ------------------------------------------ |
| code     | string  | E0000000000 | true     | 状态码，E0000000000 表示成功，其余均为失败 |
| message  | string  | 成功        | true     | 状态说明                                   |
| content  | byte\[] | 空          | false    | 消息序列化后的字节数组                     |

#### 2.2.3 快速获取数据接口

容器调用通信模块接口快速获取数据，即在非阻塞情况下从通信信道中读取一次数据，若信道中有数据则返回数据，无数据则返回空。

```shell
HTTP POST /v1/interconn/chan/peek
请求头:
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

**请求体**

| 参数名称 | 数据类型 | 默认值 | 是否必填 | 描述                                                 |
| -------- | -------- | ------ | -------- | ---------------------------------------------------- |
| topic    | string   | 空     | false    | 会话主题，相同信道具有唯一性，用于同一信道的传输隔离 |

**响应体**

| 参数名称 | 类型    | 默认值      | 是否必填 | 描述                                       |
| -------- | ------- | ----------- | -------- | ------------------------------------------ |
| code     | string  | E0000000000 | true     | 状态码，E0000000000 表示成功，其余均为失败 |
| message  | string  | 成功        | true     | 状态说明                                   |
| content  | byte\[] | 空          | false    | 消息序列化后的字节数组                     |

#### 2.2.4 会话释放接口

容器调用通信模块接口，清理掉以 x-ptp-session-id 标记的会话，调用该接口会释放会话中未读取的数据。

```shell
HTTP POST /v1/interconn/chan/release
请求头:
x-ptp-tech-provider-code:    required 厂商编码
x-ptp-trace-id:              required 链路追踪ID
x-ptp-token                  required 认证令牌
x-ptp-session-id             required 通信会话号，全网唯一
x-ptp-target-node-id         required 接收端节点编号，全网唯一
x-ptp-target-inst-id         optional 接收端机构编号，全网唯一
```

**请求体**

| 参数名称 | 数据类型 | 默认值 | 是否必填 | 描述                                                 |
| -------- | -------- | ------ | -------- | ---------------------------------------------------- |
| timeout  | byte\[]  | 空     | false    | 释放最长等待时间，默认 10s                           |
| topic    | string   | 空     | false    | 会话主题，相同信道具有唯一性，用于同一信道的传输隔离 |

**响应体**

| 参数名称 | 类型   | 默认值      | 是否必填 | 描述                                       |
| -------- | ------ | ----------- | -------- | ------------------------------------------ |
| code     | string | E0000000000 | true     | 状态码，E0000000000 表示成功，其余均为失败 |
| message  | string | 成功        | true     | 状态说明                                   |

### 2.3 运行模式

容器调用通信接口支持主动模式和被动模式两种运行模式。接口功能支持以下内容：

a) 发送信息，向通信信道中发送数据；

b) 接收信息：接收信息两种模式，主动模式和被动模式，主动模式必选，被动模式可选：

- 主动模式即为算法容器主动向传输模块发起请求获取通道中的数据，应包括：
  (1)获取信息，阻塞情况下，从通信信道中读取数据；
  (2)快速查询，非阻塞情况下，从通信信道中读取数据；

- 被动模式即为算法容器启动时监听端口，传输模块收到信息后直接转发给算法容器端口。

c) 会话释放，可选，释放信道中的一个会话。

### 3 传输编程接口

### 3.1 传输编程接口定义

算法组件调用自身容器的传输编程接口。接口以 Python 语言作为示例，其他语言参考本文档的 4 标准实现库。

```python

from abc import abstractmethod, ABC
from typing import Generic, Dict

from mesh.macro import spi, mpi, T


@spi("mesh")
class Transport(ABC, Generic[T]):
    """
    Private compute data channel in async and blocking mode.
    """

    MESH = "mesh"
    GRPC = "grpc"

    @abstractmethod
    @mpi("mesh.chan.open")
    def open(self, session_id: str, metadata: Dict[str, str]) -> "Session":
        """
        Metadata 包含如下KEY，这些值会在Session句柄中持久，在传输时候使用

        mesh.mpc.address:            required 本方通信组件地址
        x-ptp-tech-provider-code:    required 厂商编码
        x-ptp-trace-id:              required 链路追踪ID
        x-ptp-token                  required 认证令牌
        x-ptp-session-id             required 通信会话号，全网唯一
        x-ptp-target-node-id         required 接收端节点编号，全网唯一
        x-ptp-target-inst-id         optional 接收端机构编号，全网唯一

        Open a channel session.
        :param session_id:  node id or inst id
        :param metadata channel metadata
        :return:
        """
        pass

    @abstractmethod
    @mpi("mesh.chan.close")
    def close(self, timeout: int):
        """
        Close the channel.
        :return:
        """
        pass

    @abstractmethod
    @mpi("mesh.chan.roundtrip")
    def roundtrip(self, payload: bytes, metadata: Dict[str, str]) -> bytes:
        """
        Roundtrip with the channel.
        :param payload:
        :param metadata:
        :return:
        """
        pass


@spi("mesh")
class Session(ABC, Generic[T]):
    """
    Remote queue in async and blocking mode.
    """

    @abstractmethod
    @mpi("mesh.chan.peek")
    def peek(self, topic: str = "") -> bytes:
        """
        Retrieves, but does not remove, the head of this queue,
        or returns None if this queue is empty.
        :param topic: message topic
        :return: the head of this queue, or None if this queue is empty
        :return:
        """
        pass

    @abstractmethod
    @mpi(name="mesh.chan.pop", timeout=120 * 1000)
    def pop(self, timeout: int, topic: str = "") -> bytes:
        """
        Retrieves and removes the head of this queue,
        or returns None if this queue is empty.
        :param timeout: timeout in mills.
        :param topic: message topic
        :return: the head of this queue, or None if this queue is empty
        """
        pass

    @abstractmethod
    @mpi("mesh.chan.push")
    def push(self, payload: bytes, metadata: Dict[str, str], topic: str = ""):
        """
        Inserts the specified element into this queue if it is possible to do
        so immediately without violating capacity restrictions.
        When using a capacity-restricted queue, this method is generally
        preferable to add, which can fail to insert an element only
        by throwing an exception.
        :param payload: message payload
        :param metadata: Message metadata
        :param topic: message topic
        :return:
        """
        pass

    @abstractmethod
    @mpi("mesh.chan.release")
    def release(self, timeout: int, topic: str = ""):
        """
        Close the channel session.
        :param timeout:
        :param topic: message topic
        :return:
        """
        pass
```

### 4 标准实现库

隐私计算互联互通传输协议标准实现为开源产品 mesh，该库主要由通信模块和多语言 SDK 组成，通信模块提供通信管控、传输及适配能力，
同时提供集群规模化及多活等高可用能力，通信模块运行模式有 OCI 容器及多架构可执行文件两种形式，支持当下所有国际和国产化 CPU、OS。

### 4.1 通信模块

通信模块提供节点间跨域通信管控和传输，[项目地址](https://github.com/be-io/interconnection-bfia)

```bash
docker pull imesh
docker run -d -e MID=xxx -p 7304:7304 imesh
```

### 4.1 Go SDK

Go SDK 提供 Golang 语言通信 SPI 集成包，实现 Go 语言节点间跨域通信管控和传输。

```bash
go get github.com/be-io/interconnection-bfia/imesh
```

### 4.2 Java SDK

Java SDK 提供 Golang 语言通信 SPI 集成包，实现 Java 语言节点间跨域通信管控和传输。

```xml

<dependency>
    <groupId>io.inc.mesh</groupId>
    <artifactId>imesh</artifactId>
    <version>0.0.1</version>
</dependency>
```

### 4.3 Python SDK

Python SDK 提供 Golang 语言通信 SPI 集成包，实现 Python 语言节点间跨域通信管控和传输。

```bash
poetry add imesh
```

### 4.4 Rust SDK

Rust SDK 提供 Golang 语言通信 SPI 集成包，实现 Rust 语言节点间跨域通信管控和传输。

```bash
cargo add imesh
```

### 4.5 Typescript SDK

Typescript SDK 提供 Golang 语言通信 SPI 集成包，实现 Typescript 语言节点间跨域通信管控和传输。

```bash
yarn add imesh
```

### 5 附录

附录提供互联互通附录文件和说明。

### 5.1 错误码表

| 编码        | 描述                     |
| ----------- | ------------------------ |
| E0000000000 | 请求成功                 |
| E0000000404 | 请求资源不存在           |
| E0000000500 | 系统异常                 |
| E0000000503 | 循环请求服务不可达       |
| E0000000400 | 请求非法                 |
| E0000000403 | 请求资源未被授权         |
| E0000000520 | 未知异常                 |
| E0000000600 | 系统不兼容               |
| E0000000601 | 请求超时                 |
| E0000000602 | 无服务实例               |
| E0000000603 | 数字证书校验异常         |
| E0000000604 | 节点授权码已过期         |
| E0000000605 | 节点组网时间已过期       |
| E0000000606 | 对方节点已禁用网络       |
| E0000000607 | 网络不通                 |
| E0000000614 | 接口未被许可调用         |
| E0000000615 | 证书签名非法             |
| E0000000616 | 报文编解码异常           |
| E0000000617 | 下游版本不匹配服务不存在 |
| E0000000618 | 节点或机构未组网         |
| E0000000619 | 地址非法或无法访问       |
| E0000000700 | 消息缓冲区满             |
| E0000000608 | 会话已释放               |
| E0000000413 | 报文超长 BodyTooLarge    |

### 5.2 Protobuf 格式声明

节点间通信接口 Protobuf 格式声明 [README.proto](mesh.x.proto)

容器调用通信模块接口 Protobuf 格式声明 [README.proto](mesh.y.proto)

### 5.3 Swagger 格式声明

节点间通信接口 Swagger 格式声明 [README.swagger.json](mesh.x.swagger.json)

![logo](./x.png)

容器调用通信模块接口 Swagger 格式声明 [README.swagger.json](mesh.y.swagger.json)

![logo](./y.png)

### 5.4 示例程序

示例程序 [examples](../examples)

### 5.5 高级特性

高级特性 [advance](./advance.md)
